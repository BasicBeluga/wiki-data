=Extended heightmap format=

The extended heightmap format aims to store most of the information of a scenario (terrain, water, towns, etc) in a NewGRF agnostic way. Since company property is not intended to be part of scenarios, this format will not be including it. Depending on the information included in the extended heightmap it will be possible to scale the extended heightmap to different sizes or it will be fixed.


NOTE: Unless mentioned otherwise, all properties are optional.


An extended heightmap is distributed as a tar file. The file includes the following parts:

* Metadata file: Stores datafile and layer data.

* Layers: Each layer stores information for each one of the points in the map.

* Object files: Each object file contains information about a given entity, such as towns.

* Language files: Language files contain the extended heightmap name and its description. There are multiple files, one for each supported language.

==Metadata file==

The metadata file must be called "metadata.txt".

===Extended heightmap section===

The first section includes information about the extended heightmap itself. The max_height, min_desired_height and max_desired height properties are used for scaling all height information present in the extended heightmap. All heights defined in the extended heightmap must be equal or lower than the max_height property. When an OpenTTD map is generated with the extended heightmap, all height values will be scaled from the extended heightmap format to an interval defined by the min_desired_height and max_desired_height values. None of these values will be scaled.

* version: This property specifies the format version used by the extended heightmap. It is a simple numerical value that will be increased whenever any format-breaking changes are introduced. It must be present in all extended heightmaps.

* max_height: This property indicates the maximum height level of the values defined in the extended heightmap. If not present, it will be assumed to be 255. It can take values in the [0, 255] interval.

* min_desired_height: Indicates the minimum height of the resulting OpenTTD map. If set above 0, the resulting map will have no sea at all. This property must be in the [0, 14] range, and it must be smaller than max_desired_height. This property has a default value of 0.

* max_desired_height: Maximum height of the resulting OpenTTD map. This property must be in the [1, 15] range, and it must be greater than min_desired_height. This property has a default value of 15.

* width: By default, the extended heightmap will be scaled to this width. The user can still choose which width to use. This information will be ignored if the heightmap is not scalable.

* height: By default, the extended heightmap will be scaled to this height. The user can still choose which height to use. This information will be ignored if the heightmap is not scalable.

* rotation: Indicates the preferred orientation for the extended heightmap. The possible values are "cw" (clockwise rotation) or "ccw" (counter clockwise rotation). OpenTTD will select this orientation automatically, but it will still allow the user to change the orientation.

* climate: By default, the extended heightmap will use this climate. OpenTTD will select this climate automatically, but it will still allow the user to change the climate. This property can use the following values: "temperate", "arctic", "tropical" and "toyland".

* Snowline: Default snowline for the extended heightmap. This value will be ignored if the climate is not set to subarctic, or if the extended heightmap is loaded with a snowline NewGRF. OpenTTD will select this snowline automatically, but it will still allow the user to change the snowline. This property must be in the [0, max_height] range.

===Layer sections===

All included layers must have their own section in this file. The [height_layer] section is compulsory, since all extended heightmaps must have a height layer. Other layers are optional. Each layer section can have a file property that indicates which file contains the layer date if not included, a default file name will be used. Layers can also have extra properties. Note that even if a layer has no extra properties and uses the default file name, it must still have an empty section. Otherwise OpenTTD will ignore the layer.

===Object file sections===

Each object file has its own section. Their file property is also optional; if not included they will use the default file name. The section must be present even if it is empty, otherwise OpenTTD will ignore the object file.

===Example of metadata file===

<pre>[extended_heightmap]
version=1
height_levels=16
width=128
height=256
orientation=ccw
climate=arctic
snowline=12

[height_layer]
file=heightmap.png

[water_layer]
file=rivers.png

[road_layer]
layer=roads.png

[town_file]
file=town_data.txt

[road_bridge_file]
file=road_bridge_file.txt</pre>

[road_tunnel_file]
file=road_tunnel_file.txt</pre>

==Layers==

Each layer stores information for each one of the points in the map in PNG format. Scalable layers are those that can be scaled to valid map sizes without a critical loss of information. Extended heightmap that include only scalable layers can have layers of any size, and they will be scaled when the game is generated.

If an extended heightmap contains one or more non scalable layers, all layers must have the same size, and it must be a valid OpenTTD map size. If these conditions are not fulfilled, OpenTTD will not be able to load the extended heightmap. Since they contain position information, object files are treated as non scalable layers in this regard. The different types of layers are described below.

===Height layer===

Metadata section: [height_layer]

Default filename: height.png

Scalable: Yes

Height layers are 8 bit grayscale images that describe the height of each point of the map as a number in the [0, 255] interval. Any heights above max_height will be clamped to max_height when generating maps.

===Terrain layer===

Metadata section: [terrain_layer]

Default filename: terrain.png

Scalable: Yes

The terrain layer is a paletted PNG image that stores information about the terrain type of each one of the tiles.

* Default: Default terrain.

* Rough: Rough terrain.

* Rock: Rocky terrain.

===Water layer===

Metadata section: [water_layer]

Default filename: water.png

Scalable: Yes

Water layers are paletted PNG images which indicate the presence or abscense of water in each tile. If a water layer is not present, OpenTTD will assume that all tiles with a resulting height of zero are sea. If the water layer is present, OpenTTD will only mark as sea those tiles indicated in the water layer (Issue: OpenTTD will flood any tiles with a height of zero in the border of the map).

Water layers include the following information:

* No water: This is not a water tile

* Sea: Only tiles at zero height can be marked as sea. OpenTTD will treat any tiles marked as sea above height zero as rivers.

* River: Used to mark tiles as river.

===Tropical layer===

Metadata section: [tropical_layer]

Default filename: tropical.png

Scalable: Yes

The tropical layer is a paletted PNG image that stores information about the subtropical type of each one of the tiles.

* Default: Default terrain.

* Desert: Desert terrain.

* Rainforest: Rainforest terrain.

===Road layer===

Metadata section: [road_layer]

Default filename: road.png

Scalable: No

Road layers are paletted PNG images that indicate the roads present in the map. Each colour indicates a different combination of roadbits.

* None: No roads are present in this tile.
* Road_NW: Only the northwest road bit is present.
* Road_SW: Only the southwest road bit is present.
* Road_SE: Only the southeast road bit is present.
* Road_NE: Only the northeast road bit is present.
* Road_X: Full road along the X axis (southwest + northeast).
* Road_Y: Full road along the Y axis (northwest + southeast).
* Road_N: Road at the two northern edges.
* Road_E: Road at the two eastern edges.
* Road_S: Road at the two southern edges.
* Road_W: Road at the two western edges.
* Road_All: Full four way crossing.

===Canal layer===

Metadata section: [canal_layer]

Default filename: canal.png

Scalable: No

Canal layers are two-colour paletted PNG images that indicate the canals and locks present in the map. A "canal" in a sloped tile indicates a lock.

===Industry layer===

An industry layer is planned, but since it is quite complicated it won't be designed until everything else is already implemented and working.

==Object files==

Object files contain text data associated to a given game entity. With regard to extended heightmap scalability, all object files are treated as non scalable layers.

The "direction" fields can take the following values:

* NE: Northeast
* NW: Northwest
* SE: Southeast
* SW: Southwest

===Town file===

Metadata section: [town_file]

Default filename: town.txt

The town file lists all towns included in the extended heightmap along with their position and properties. If this object file is not present, towns will be randomly generated accordingly to the current OpenTTD settings. There is a [town] section for each town, and it includes the following properties:

<pre>[town]
name=Town Name 1
posx=59
posy=12
buildings=32
city=false
layout=random</pre>

* posx: X position of the town. This property is obligatory.

* posy: Y position of the town. This property is obligatory.

* name: Town name. If missing, a random town name (with the selected town name generator) will be used.

* buildings: Number of buildings that this town will have. If missing, the default size for current OpenTTD settings will be used.

* city: True iff the town will grow faster than other towns. The default value is "false".

* layout: Road layout to use in this town. It can be "original", "better" (better roads), "2x2", "3x3" and "random". If this property is missing, the current layout chosen in OpenTTD options will be used.

===Road bridge file===

Metadata section: [road_bridge_file]

Default filename: road_bridge.txt

This file stores all road bridges. All properties are obligatory.

* posx: Horizontal position of the bridge.

* posy: Vertical position of the bridge.

* direction: Direction of the bridge.

* length: Length of the bridge.

* max_speed: Preferred maximum speed of the bridge in km-ish/h. If OpenTTD can't find a bridge that uses this maximum speed, it will choose the bridge with the nearest lower maximum speed.

<pre>[bridge]
posx=12
posy=95
direction=SW
length=12
max_speed=220</pre>

===Road tunnel file===

Metadata section: [road_tunnel_file]

Default filename: road_tunnel.txt

This file stores all road tunnels. All properties are obligatory.

* posx: Horizontal position of the tunnel.

* posy: Vertical position of the tunnel.

<pre>[tunnel]
posx=34
posy=59</pre>

===Aqueducts===

Metadata section: [water_bridge_file]

Default filename: water_bridge.txt

This file stores all aqueducts. All properties are obligatory.

<pre>[water_bridge]
posx=12
posy=950</pre>